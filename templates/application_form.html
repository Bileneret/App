{% extends "base.html" %}
{% if mode == "create" %}
    {% set page_title = "–ù–æ–≤–∞ –∑–∞—è–≤–∫–∞" %}
{% else %}
    {% set page_title = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞—è–≤–∫–∏" %}
{% endif %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<h1>{{ page_title }}</h1>

<form method="post" enctype="multipart/form-data" id="appForm">
    <label for="title">–ù–∞–∑–≤–∞ –∑–∞—è–≤–∫–∏</label>
    <input type="text" id="title" name="title" required
           value="{{ title_value or '' }}">

    <label for="short_description">–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å</label>
    <textarea id="short_description" name="short_description" rows="6" required
              class="auto-expand"
              style="width:100%; padding:10px; border-radius:4px; border:1px solid #333; background: #2d2d2d; color: white;">{{ description_value or '' }}</textarea>

    {% if application and application.files %}
        <label>–í–∂–µ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏:</label>
        <ul class="file-upload-list" style="margin-bottom: 20px;">
            {% for f in application.files %}
                {% set ext = f.filename.split('.')[-1].lower() %}
                <li class="file-upload-item">
                    <span class="file-upload-name">‚úÖ {{ f.filename }}</span>
                    <div class="file-upload-actions">
                        <button type="button" class="action-btn" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏"
                                onclick="openPreview('{{ url_for('download_file', filename=f.filename) }}', '{{ ext }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <button type="button" class="action-btn delete" title="–í–∏–¥–∞–ª–∏—Ç–∏"
                                onclick="deleteServerFile('{{ url_for('delete_file_route', file_id=f.id) }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <label>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—ñ —Ñ–∞–π–ª–∏</label>
    <p style="margin-top: -5px; margin-bottom: 10px; font-size: 0.9rem; color: #a0a0a0;">
        ‚ÑπÔ∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤: <strong>10</strong>.
    </p>

    <label for="files" class="custom-file-upload">
        üìÇ –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª–∏...
    </label>
    <input type="file" id="files" name="files" multiple onchange="handleFileSelect(event)">

    <ul id="newFileList" class="file-upload-list" style="display: none;"></ul>

    <button type="submit">
        {% if mode == "create" %}–°—Ç–≤–æ—Ä–∏—Ç–∏{% else %}–ó–±–µ—Ä–µ–≥—Ç–∏{% endif %}
    </button>
</form>

{% if application %}
    <hr style="margin: 40px 0; border-top: 1px solid var(--border);">
    <h3>–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω —Ç–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤</h3>

    <div style="background: var(--bg-body); border-radius: 8px; border: 1px solid var(--border); padding: 20px;">
        {% if application.history %}
            <div class="timeline">
                {% for event in application.history %}
                    <div class="timeline-item">
                        <div class="timeline-header">
                            <span class="timeline-date">{{ event.created_at.strftime('%Y-%m-%d %H:%M') }}</span>

                            {% if event.event_type == 'created' %}
                                <span class="status-badge" style="background:#333; border:1px solid #555;">–°—Ç–≤–æ—Ä–µ–Ω–æ</span>
                            {% elif event.event_type == 'edited' %}
                                <span class="status-badge" style="background:#0c4a6e; border:1px solid #0ea5e9; color:#bae6fd;">–í—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ</span>
                            {% elif event.event_type == 'status_change' %}
                                <span class="status-badge" style="background:#4c1d95; border:1px solid #8b5cf6; color:#ddd6fe;">–ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É</span>
                            {% endif %}

                            <span style="margin-left: 10px; color: var(--text-muted); font-size: 0.9rem;">
                                –ö–∏–º: {{ event.changed_by.email }} ({{ event.changed_by.role }})
                            </span>
                        </div>

                        <div class="timeline-content">
                            {% if event.snapshot_status %}
                                <p style="margin: 5px 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ event.snapshot_status }}</p>
                            {% endif %}

                            {% if event.snapshot_comment %}
                                <div style="margin-top: 10px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--primary); border-radius: 4px; color: #e0e0e0;">
                                    <strong>–ö–æ–º–µ–Ω—Ç–∞—Ä:</strong><br>
                                    {{ event.snapshot_comment }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if not loop.last %}<hr style="border-top: 1px dashed #333; margin: 15px 0;">{% endif %}
                {% endfor %}
            </div>
        {% else %}
            <p style="color: var(--text-muted);">–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω –≤—ñ–¥—Å—É—Ç–Ω—è.</p>
        {% endif %}
    </div>
{% endif %}

<p style="margin-top: 20px;">
    <a href="{{ url_for('my_applications') }}">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É –∑–∞—è–≤–æ–∫</a>
</p>

<form id="deleteFileForm" method="post" style="display:none;"></form>

<div id="previewModal" class="modal">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <div class="modal-content">
        <div id="modalBody"></div>
    </div>
</div>

<script>
    // --- –ê–í–¢–û-–†–û–ó–®–ò–†–ï–ù–ù–Ø TEXTAREA ---
    const textarea = document.getElementById('short_description');

    function autoResize() {
        this.style.height = 'auto'; // –°–∫–∏–¥–∞—î–º–æ –≤–∏—Å–æ—Ç—É
        this.style.height = this.scrollHeight + 'px'; // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
    }

    if (textarea) {
        textarea.setAttribute('style', 'height:' + (textarea.scrollHeight) + 'px;overflow-y:hidden;');
        textarea.addEventListener("input", autoResize, false);
        // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ (–¥–ª—è —Ä–µ–∂–∏–º—É —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è)
        setTimeout(() => {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }, 100);
    }

    // --- –õ–æ–≥—ñ–∫–∞ —Ñ–∞–π–ª—ñ–≤ ---
    let selectedFiles = [];
    const MAX_FILES = 10;

    function handleFileSelect(event) {
        const input = event.target;
        if (!input.files || input.files.length === 0) return;
        for (let i = 0; i < input.files.length; i++) {
            selectedFiles.push(input.files[i]);
        }
        updateFileListUI();
    }

    function updateFileListUI() {
        const listEl = document.getElementById('newFileList');
        const input = document.getElementById('files');
        selectedFiles.sort((a, b) => a.name.localeCompare(b.name));
        listEl.innerHTML = '';

        if (selectedFiles.length > 0) {
            listEl.style.display = 'block';
            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-upload-item';

                li.innerHTML = `
                    <span class="file-upload-name">üÜï ${file.name}</span>
                    <div class="file-upload-actions">
                        <button type="button" class="action-btn" onclick="previewLocalFile(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <button type="button" class="action-btn delete" onclick="removeLocalFile(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        } else {
            listEl.style.display = 'none';
        }

        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
    }

    function removeLocalFile(index) {
        selectedFiles.splice(index, 1);
        updateFileListUI();
    }

    function previewLocalFile(index) {
        const file = selectedFiles[index];
        const ext = file.name.split('.').pop().toLowerCase();
        const objectUrl = URL.createObjectURL(file);
        openPreview(objectUrl, ext);
    }

    function deleteServerFile(url) {
        if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª?")) {
            const form = document.getElementById('deleteFileForm');
            form.action = url;
            form.submit();
        }
    }

    // --- –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û ---
    var modal = document.getElementById("previewModal");
    var modalBody = document.getElementById("modalBody");

    function openPreview(url, ext) {
        modal.style.display = "block";
        modalBody.innerHTML = "";

        const nativeImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'];
        const nativeIframe = ['pdf', 'txt', 'mp4', 'webm', 'mp3'];
        const officeTypes = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'];

        if (nativeImage.includes(ext)) {
            var img = document.createElement("img");
            img.src = url;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";
            modalBody.appendChild(img);
        } else if (nativeIframe.includes(ext)) {
            var iframe = document.createElement("iframe");
            iframe.src = url;
            iframe.style.width = "100%";
            iframe.style.height = "100%";
            iframe.style.border = "none";
            iframe.style.backgroundColor = "#fff";
            modalBody.appendChild(iframe);
        } else if (officeTypes.includes(ext)) {
            if (url.startsWith('blob:')) {
                 modalBody.innerHTML = "<div style='color:white; text-align:center; padding: 20px;'>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ Office-—Ñ–∞–π–ª—ñ–≤ –¥–æ—Å—Ç—É–ø–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞—è–≤–∫–∏.</div>";
            } else {
                var fullUrl = window.location.origin + url;
                var iframe = document.createElement("iframe");
                iframe.src = "https://view.officeapps.live.com/op/embed.aspx?src=" + encodeURIComponent(fullUrl);
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.style.border = "none";
                iframe.style.backgroundColor = "#fff";
                modalBody.appendChild(iframe);

                var btn = document.createElement("a");
                btn.href = url;
                btn.download = "";
                btn.innerText = "‚¨á –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–ø—ñ—é";
                btn.className = "action-btn-unified btn-green";
                btn.style.cssText = "position: absolute; bottom: 20px; right: 20px; z-index: 10005; box-shadow: 0 0 10px rgba(0,0,0,0.5);";
                modalBody.appendChild(btn);

                if (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") {
                    var warning = document.createElement("div");
                    warning.innerText = "‚ö†Ô∏è –ù–∞ localhost –ø–µ—Ä–µ–≥–ª—è–¥ Office-—Ñ–∞–π–ª—ñ–≤ –Ω–µ –ø—Ä–∞—Ü—é—î.";
                    warning.style.cssText = "position:absolute; top:10px; left:50%; transform:translateX(-50%); background:orange; padding:10px; z-index:10002; color:black;";
                    modalBody.appendChild(warning);
                }
            }
        } else {
            modalBody.innerHTML = `
                <div style="text-align: center; color: #e0e0e0;">
                    <div style="font-size: 5rem; margin-bottom: 20px;">üìÑ</div>
                    <p style="font-size: 1.5rem; margin-bottom: 10px;">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π</p>
                    <p style="color: #a0a0a0; margin-bottom: 30px;">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –º–æ–∂–µ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Ñ–∞–π–ª —Ç–∏–ø—É <b>.${ext}</b>.</p>
                    <a href="${url}" class="action-btn-unified btn-green" download style="display: inline-block; padding: 12px 24px; font-size: 1rem;">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª</a>
                </div>
            `;
        }
    }

    function closeModal() {
        modal.style.display = "none";
        modalBody.innerHTML = "";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}