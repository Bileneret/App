{% extends "base.html" %}
{% if mode == "create" %}
    {% set page_title = "–ù–æ–≤–∞ –∑–∞—è–≤–∫–∞" %}
{% else %}
    {% set page_title = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞—è–≤–∫–∏" %}
{% endif %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<h1>{{ page_title }}</h1>

<form method="post" enctype="multipart/form-data" id="appForm">
    <label for="title">–ù–∞–∑–≤–∞ –∑–∞—è–≤–∫–∏</label>
    <input type="text" id="title" name="title" required
           value="{{ title_value or '' }}">

    <label for="short_description">–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å</label>
    <textarea id="short_description" name="short_description" rows="6" required
              style="width:100%; padding:8px; border-radius:4px; border:1px solid #d1d5db;">{{ description_value or '' }}</textarea>

    {% if application and application.files %}
        <label>–í–∂–µ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏:</label>
        <ul class="file-upload-list" style="margin-bottom: 20px;">
            {% for f in application.files %}
                {% set ext = f.filename.split('.')[-1].lower() %}
                <li class="file-upload-item">
                    <span class="file-upload-name">‚úÖ {{ f.filename }}</span>
                    <div class="file-upload-actions">
                        <button type="button" class="action-btn" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏"
                                onclick="openPreview('{{ url_for('download_file', filename=f.filename) }}', '{{ ext }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>

                        <button type="button" class="action-btn delete" title="–í–∏–¥–∞–ª–∏—Ç–∏"
                                onclick="deleteServerFile('{{ url_for('delete_file_route', file_id=f.id) }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <label>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—ñ —Ñ–∞–π–ª–∏ (–õ—ñ–º—ñ—Ç: –¥–æ 10 —Ñ–∞–π–ª—ñ–≤ —Å—É–º–∞—Ä–Ω–æ —Ç–∞ –Ω–µ –±—ñ–ª—å—à–µ 100–ú–ë)</label>

    <label for="files" class="custom-file-upload">
        üìÇ –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª–∏...
    </label>
    <input type="file" id="files" name="files" multiple onchange="handleFileSelect(event)">

    <ul id="newFileList" class="file-upload-list" style="display: none;"></ul>

    <button type="submit">
        {% if mode == "create" %}–°—Ç–≤–æ—Ä–∏—Ç–∏{% else %}–ó–±–µ—Ä–µ–≥—Ç–∏{% endif %}
    </button>
</form>

<p>
    <a href="{{ url_for('my_applications') }}">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É –∑–∞—è–≤–æ–∫</a>
</p>

<form id="deleteFileForm" method="post" style="display:none;"></form>

<div id="previewModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>

<script>
    // --- –ó–ú–Ü–ù–ù–Ü ---
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—Å—ñ –≤–∏–±—Ä–∞–Ω—ñ —Ñ–∞–π–ª–∏ –≤ –º–∞—Å–∏–≤—ñ, —â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ –≤–∏–¥–∞–ª—è—Ç–∏ –æ–∫—Ä–µ–º–æ
    let selectedFiles = [];
    const MAX_FILES = 10;

    // –í—Ä–∞—Ö–æ–≤—É—î–º–æ —Ñ–∞–π–ª–∏, —è–∫—ñ –≤–∂–µ —î –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ (—è–∫—â–æ —Ü–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è)
    const existingFilesCount = {{ application.files|length if application and application.files else 0 }};

    // --- –§–£–ù–ö–¶–Ü–á –î–õ–Ø –ù–û–í–ò–• –§–ê–ô–õ–Ü–í ---

    function handleFileSelect(event) {
        const input = event.target;
        if (!input.files || input.files.length === 0) return;

        // –î–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ —Ñ–∞–π–ª–∏ –¥–æ –Ω–∞—à–æ–≥–æ –º–∞—Å–∏–≤—É
        for (let i = 0; i < input.files.length; i++) {
            selectedFiles.push(input.files[i]);
        }

        updateFileListUI();
    }

    function updateFileListUI() {
        const listEl = document.getElementById('newFileList');
        const input = document.getElementById('files');

        // 1. –°–æ—Ä—Ç—É—î–º–æ –ø–æ –∞–ª—Ñ–∞–≤—ñ—Ç—É
        selectedFiles.sort((a, b) => a.name.localeCompare(b.name));

        // 2. –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        listEl.innerHTML = '';

        if (selectedFiles.length > 0) {
            listEl.style.display = 'block';

            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-upload-item';

                // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –¥–ª—è –ø—Ä–µ–≤'—é
                const ext = file.name.split('.').pop().toLowerCase();

                li.innerHTML = `
                    <span class="file-upload-name">üÜï ${file.name}</span>
                    <div class="file-upload-actions">
                        <button type="button" class="action-btn" onclick="previewLocalFile(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <button type="button" class="action-btn delete" onclick="removeLocalFile(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        } else {
            listEl.style.display = 'none';
        }

        // 3. –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –º–∞—Å–∏–≤ –∑ —Ä–µ–∞–ª—å–Ω–∏–º input (—á–µ—Ä–µ–∑ DataTransfer)
        // –¶–µ –º–∞–≥—ñ—è, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª—ñ–≤
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
    }

    function removeLocalFile(index) {
        selectedFiles.splice(index, 1);
        updateFileListUI();
    }

    function previewLocalFile(index) {
        const file = selectedFiles[index];
        const ext = file.name.split('.').pop().toLowerCase();

        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π URL –¥–ª—è —Ñ–∞–π–ª—É
        const objectUrl = URL.createObjectURL(file);
        openPreview(objectUrl, ext);
    }

    // --- –§–£–ù–ö–¶–Ü–á –î–õ–Ø –°–ï–†–í–ï–†–ù–ò–• –§–ê–ô–õ–Ü–í ---

    function deleteServerFile(url) {
        if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª?")) {
            const form = document.getElementById('deleteFileForm');
            form.action = url;
            form.submit();
        }
    }

    // --- –§–£–ù–ö–¶–Ü–á –ú–û–î–ê–õ–¨–ù–û–ì–û –í–Ü–ö–ù–ê (–°–ø—ñ–ª—å–Ω—ñ) ---

    var modal = document.getElementById("previewModal");
    var modalBody = document.getElementById("modalBody");

    function openPreview(url, ext) {
        modal.style.display = "block";
        modalBody.innerHTML = "";

        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
            var img = document.createElement("img");
            img.src = url;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "80vh";
            modalBody.appendChild(img);
        } else if (['pdf', 'txt'].includes(ext)) {
            var iframe = document.createElement("iframe");
            iframe.src = url;
            iframe.style.width = "100%";
            iframe.style.height = "80vh";
            iframe.style.border = "none";
            modalBody.appendChild(iframe);
        } else {
            modalBody.innerHTML = "<p style='color:white; text-align:center; padding: 50px;'>–ü–µ—Ä–µ–≥–ª—è–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è —Ü—å–æ–≥–æ —Ç–∏–ø—É —Ñ–∞–π–ª—É.</p>";
        }
    }

    function closeModal() {
        modal.style.display = "none";
        modalBody.innerHTML = "";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}