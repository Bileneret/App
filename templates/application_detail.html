{% extends "base.html" %}
{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ application.id }}{% endblock %}

{% block content %}
<h1>–ó–∞—è–≤–∫–∞ ‚Ññ{{ application.id }}</h1>

<div style="margin-bottom: 20px;">
    <p><strong>–ù–∞–∑–≤–∞:</strong> {{ application.title }}</p>
    <div style="margin: 10px 0; display: flex; align-items: center; gap: 10px;">
        <strong>–°—Ç–∞—Ç—É—Å:</strong>

        {% if application.status == 'draft' %}
            <span class="status-badge status-draft">–ß–æ—Ä–Ω–µ—Ç–∫–∞</span>
        {% elif application.status == 'submitted' %}
            <span class="status-badge status-submitted">–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ</span>
        {% elif application.status == 'needs_changes' %}
            <span class="status-badge status-needs-changes">–ü–æ—Ç—Ä–µ–±—É—î –∑–º—ñ–Ω</span>
        {% elif application.status == 'approved' %}
            <span class="status-badge status-approved">–°—Ö–≤–∞–ª–µ–Ω–æ</span>
        {% elif application.status == 'rejected' %}
            <span class="status-badge status-rejected">–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</span>
        {% elif application.status == 'cancelled' %}
            <span class="status-badge status-cancelled">–°–∫–∞—Å–æ–≤–∞–Ω–æ</span>
        {% else %}
            {{ application.status }}
        {% endif %}
    </div>
    <p><strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong> {{ application.created_at.strftime('%Y-%m-%d') }}</p>
</div>

{% if application.files %}
    <h3 style="margin-top: 30px;">–ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏</h3>
    <div class="file-gallery">
        {% for f in application.files %}
            {% set ext = f.filename.split('.')[-1].lower() %}
            <div class="file-card">
                <div class="file-preview">
                    {% if ext in ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp'] %}
                        <img src="{{ url_for('download_file', filename=f.filename) }}" alt="Preview">
                    {% else %}
                        <div class="file-icon">üìÑ</div>
                    {% endif %}
                </div>

                <div class="file-info">
                    <span class="file-name" title="{{ f.filename }}">{{ f.filename }}</span>
                    <div class="file-actions">
                        <button type="button" class="icon-btn" onclick="openPreview('{{ url_for('download_file', filename=f.filename) }}', '{{ ext }}')" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                        <a href="{{ url_for('download_file', filename=f.filename) }}" class="icon-btn" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏" download>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M12 9.75l-3 3m0 0l3 3m-3-3l-3 3M12 9.75V3" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if application.expert_comment %}
    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 6px; margin: 20px 0;">
        <h3 style="color: var(--primary); margin-top: 0;">–ö–æ–º–µ–Ω—Ç–∞—Ä –µ–∫—Å–ø–µ—Ä—Ç–∞:</h3>
        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ application.expert_comment }}</p>
    </div>
{% endif %}

<h2>–û–ø–∏—Å</h2>
<p class="description-content">{{ application.short_description }}</p>

<hr>

{% if g.user.id == application.owner_id %}
    {% if application.status in ("draft", "needs_changes") %}
        <div style="display: flex; gap: 10px; align-items: center; margin-top: 20px;">
            <a href="{{ url_for('edit_application', application_id=application.id) }}"
               class="action-btn-unified btn-yellow">
               –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ / –§–∞–π–ª–∏
            </a>

            <form action="{{ url_for('submit_application', application_id=application.id) }}" method="post" style="margin: 0;">
                <button type="submit" class="action-btn-unified btn-green"
                        onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–¥–∞—Ç–∏ —Ü—é –∑–∞—è–≤–∫—É? –ü—ñ—Å–ª—è –ø–æ–¥–∞—á—ñ –≤–∏ –Ω–µ –∑–º–æ–∂–µ—Ç–µ —ó—ó —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏.');">
                    –ü–æ–¥–∞—Ç–∏ –Ω–∞ —Ä–æ–∑–≥–ª—è–¥
                </button>
            </form>
        </div>

    {% elif application.status == "submitted" %}
        <p>–ó–∞—è–≤–∫—É –ø–æ–¥–∞–Ω–æ. –û—á—ñ–∫—É–π—Ç–µ —Ä—ñ—à–µ–Ω–Ω—è –µ–∫—Å–ø–µ—Ä—Ç–∞.</p>
        <form action="{{ url_for('cancel_application', application_id=application.id) }}" method="post">
            <button type="submit" class="action-btn-unified btn-red"
                    onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü—é –∑–∞—è–≤–∫—É?');">
                –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞—è–≤–∫—É
            </button>
        </form>

    {% elif application.status == "approved" %}
        <p style="color: var(--text-muted);">–í—ñ—Ç–∞—î–º–æ! –í–∞—à—É –∑–∞—è–≤–∫—É —Å—Ö–≤–∞–ª–µ–Ω–æ.</p>
    {% endif %}
{% endif %}

<p style="margin-top: 20px;">
    <a href="{{ url_for('my_applications') }}">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É</a>
</p>

<div id="previewModal" class="modal">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <div class="modal-content">
        <div id="modalBody"></div>
    </div>
</div>

<script>
    var modal = document.getElementById("previewModal");
    var modalBody = document.getElementById("modalBody");

    function openPreview(url, ext) {
        modal.style.display = "block";
        modalBody.innerHTML = "";

        const nativeImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'];
        const nativeIframe = ['pdf', 'txt', 'mp4', 'webm', 'mp3'];
        const officeTypes = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'];

        if (nativeImage.includes(ext)) {
            var img = document.createElement("img");
            img.src = url;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";
            modalBody.appendChild(img);
        } else if (nativeIframe.includes(ext)) {
            var iframe = document.createElement("iframe");
            iframe.src = url;
            iframe.style.width = "100%";
            iframe.style.height = "100%";
            iframe.style.border = "none";
            iframe.style.backgroundColor = "#fff";
            modalBody.appendChild(iframe);
        } else if (officeTypes.includes(ext)) {
            var fullUrl = window.location.origin + url;
            var iframe = document.createElement("iframe");
            iframe.src = "https://view.officeapps.live.com/op/embed.aspx?src=" + encodeURIComponent(fullUrl);
            iframe.style.width = "100%";
            iframe.style.height = "100%";
            iframe.style.border = "none";
            iframe.style.backgroundColor = "#fff";
            modalBody.appendChild(iframe);

            var btn = document.createElement("a");
            btn.href = url;
            btn.download = "";
            btn.innerText = "‚¨á –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–ø—ñ—é";
            btn.className = "action-btn-unified btn-green";
            btn.style.cssText = "position: absolute; bottom: 20px; right: 20px; z-index: 10005; box-shadow: 0 0 10px rgba(0,0,0,0.5);";
            modalBody.appendChild(btn);

            if (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") {
                var warning = document.createElement("div");
                warning.innerText = "‚ö†Ô∏è –ù–∞ localhost –ø–µ—Ä–µ–≥–ª—è–¥ Office-—Ñ–∞–π–ª—ñ–≤ –Ω–µ –ø—Ä–∞—Ü—é—î.";
                warning.style.cssText = "position:absolute; top:10px; left:50%; transform:translateX(-50%); background:orange; padding:10px; z-index:10002; color:black;";
                modalBody.appendChild(warning);
            }
        } else {
            modalBody.innerHTML = `
                <div style="text-align: center; color: #e0e0e0;">
                    <div style="font-size: 5rem; margin-bottom: 20px;">üìÑ</div>
                    <p style="font-size: 1.5rem; margin-bottom: 10px;">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π</p>
                    <p style="color: #a0a0a0; margin-bottom: 30px;">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –º–æ–∂–µ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Ñ–∞–π–ª —Ç–∏–ø—É <b>.${ext}</b>.</p>
                    <a href="${url}" class="action-btn-unified btn-green" download style="display: inline-block; padding: 12px 24px; font-size: 1rem;">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª</a>
                </div>
            `;
        }
    }

    function closeModal() {
        modal.style.display = "none";
        modalBody.innerHTML = "";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}